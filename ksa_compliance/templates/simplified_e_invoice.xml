<?xml version="1.0" encoding="UTF-8"?>
<Invoice xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
         xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
         xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
         xmlns:ext="urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2">

    <!-- TODO: Cryptographic stamp-->
    <ext:UBLExtensions>
        <ext:UBLExtension>
            <ext:ExtensionURI>urn:oasis:names:specification:ubl:dsig:enveloped:xades</ext:ExtensionURI>
            <ext:ExtensionContent>
                <sig:UBLDocumentSignatures
                        xmlns:sig="urn:oasis:names:specification:ubl:schema:xsd:CommonSignatureComponents-2"
                        xmlns:sac="urn:oasis:names:specification:ubl:schema:xsd:SignatureAggregateComponents-2"
                        xmlns:sbc="urn:oasis:names:specification:ubl:schema:xsd:SignatureBasicComponents-2">
                    <sac:SignatureInformation>
                    </sac:SignatureInformation>
                </sig:UBLDocumentSignatures>
            </ext:ExtensionContent>
        </ext:UBLExtension>
    </ext:UBLExtensions>

    <cbc:ProfileID>reporting:1.0</cbc:ProfileID>

    <cbc:ID>{{ invoice.id }}</cbc:ID>
    <cbc:UUID>{{ invoice.uuid }}</cbc:UUID>
    <cbc:IssueDate>{{ invoice.issue_date }}</cbc:IssueDate>
    <cbc:IssueTime>{{ invoice.issue_time }}</cbc:IssueTime>

    <cbc:InvoiceTypeCode name="{{ invoice.invoice_type_transaction }}">{{ invoice.invoice_type_code }}
    </cbc:InvoiceTypeCode>
    <!-- Note unstructured text -->
    <cbc:Note>This is a note</cbc:Note>
    <cbc:DocumentCurrencyCode>{{ invoice.currency_code }}</cbc:DocumentCurrencyCode>
    <cbc:TaxCurrencyCode>{{ invoice.tax_currency or 'SAR'}}</cbc:TaxCurrencyCode>

    <!-- TODO: Discussion if it sales order or purchase order -->
    {% if invoice.po_no %}
    <cac:OrderReference>
        <cbc:ID>{{ invoice.po_no }}</cbc:ID> <!-- Purchase Order-->
    </cac:OrderReference>
    {% endif %}

    <!--Return against invoice ID-->
    {% if invoice.is_return or invoice.is_debit_note %}
    <cac:BillingReference>
        <cac:InvoiceDocumentReference>
            <cbc:ID>{{ invoice.return_against }}</cbc:ID>
        </cac:InvoiceDocumentReference>
    </cac:BillingReference>
    {% endif %}

    <!-- Contract ID -->
    {% if invoice.contract_id %}
    <cac:ContractDocumentReference>
        <cbc:ID>{{ invoice.contract_id }}</cbc:ID>
    </cac:ContractDocumentReference>
    {% endif %}

    <!-- TODO: Discussion GENERATED FIELDS-->
    <cac:AdditionalDocumentReference>
        <cbc:ID>ICV</cbc:ID>
        <cbc:UUID>{{ invoice.invoice_counter_value }}</cbc:UUID>
    </cac:AdditionalDocumentReference>
    <cac:AdditionalDocumentReference>
        <cbc:ID>PIH</cbc:ID>
        <cac:Attachment>
            <cbc:EmbeddedDocumentBinaryObject mimeCode="text/plain"> {{ invoice.pih }}</cbc:EmbeddedDocumentBinaryObject>
        </cac:Attachment>
    </cac:AdditionalDocumentReference>

    <!-- Seller info -->
    <cac:AccountingSupplierParty>
        <cac:Party>
            <!-- Additional seller IDs -->
            {% if seller_details.party_identifications %}
            {% for key, val in seller_details.party_identifications.items() %}
            <cac:PartyIdentification>
                <cbc:ID schemeID="{{key}}">{{val}}</cbc:ID>
            </cac:PartyIdentification>
            {% endfor %}
            {% endif %}
            <cac:PostalAddress>
                <cbc:StreetName>{{ seller_details.street_name }}</cbc:StreetName>
                <cbc:BuildingNumber>{{ seller_details.building_number }}</cbc:BuildingNumber>
                {% if seller_details.address_additional_number %}
                <cbc:PlotIdentification>{{ seller_details.address_additional_number }}</cbc:PlotIdentification>
                {% endif %}
                <cbc:CitySubdivisionName>{{ seller_details.city_subdivision_name }}</cbc:CitySubdivisionName>
                <cbc:CityName>{{ seller_details.city_name }}</cbc:CityName>
                <cbc:PostalZone>{{ seller_details.postal_zone }}</cbc:PostalZone>
                {% if seller_details.province %}
                <cbc:CountrySubentity>{{ seller_details.province }}</cbc:CountrySubentity>
                {% endif %}
                <cac:Country>
                    <cbc:IdentificationCode>{{ seller_details.country_code }}</cbc:IdentificationCode>
                </cac:Country>
            </cac:PostalAddress>

            <cac:PartyTaxScheme>
                <!-- Vat Registration Number -->
                <cbc:CompanyID>{{business_settings.company_id}}</cbc:CompanyID>
                <!-- TODO: Discussion-->
                <cac:TaxScheme>
                    <cbc:ID>VAT</cbc:ID>
                </cac:TaxScheme>
            </cac:PartyTaxScheme>

            <cac:PartyLegalEntity>
                <cbc:RegistrationName>{{ business_settings.registration_name }}</cbc:RegistrationName>
            </cac:PartyLegalEntity>
        </cac:Party>
    </cac:AccountingSupplierParty>
    <!-- Buyer info -->
    <cac:AccountingCustomerParty>
        <cac:Party>
            {% if buyer_details.party_identifications %}
            {% for it in buyer_details.party_identifications %}
            <cac:PartyIdentification>
                <cbc:ID schemeID="{{ it.code }}">{{ it.value }}</cbc:ID>
            </cac:PartyIdentification>
            {% endfor %}
            {% endif %}
            <cac:PostalAddress>
                <cbc:StreetName>{{ buyer_details.street_name }}</cbc:StreetName>
                {% if buyer_details.building_number %}
                <cbc:BuildingNumber>{{ buyer_details.building_number }}</cbc:BuildingNumber>
                {% endif %}
                {% if buyer_details.address_additional_number %}
                <cbc:PlotIdentification>{{ buyer_details.address_additional_number }}</cbc:PlotIdentification>
                {% endif %}
                {% if buyer_details.city_subdivision_name %}
                <cbc:CitySubdivisionName>{{ buyer_details.city_subdivision_name }}</cbc:CitySubdivisionName>
                {% endif %}
                {% if buyer_details.city_name %}
                <cbc:CityName>{{ buyer_details.city_name }}</cbc:CityName>
                {% endif %}
                {% if buyer_details.postal_zone %}
                <cbc:PostalZone>{{ buyer_details.postal_zone }}</cbc:PostalZone>
                {% endif %}
                {% if buyer_details.province %}
                <cbc:CountrySubentity>{{ buyer_details.province }}</cbc:CountrySubentity>
                {% endif %}
                {% if buyer_details.country_code %}
                <cac:Country>
                    <cbc:IdentificationCode>{{ buyer_details.country_code }}</cbc:IdentificationCode>
                </cac:Country>
                {% endif %}
            </cac:PostalAddress>
            {% if buyer_details.vat_id %}
            <cac:PartyTaxScheme>
                <cac:TaxScheme>
                    <!-- Vat Registration Number -->
                    <cbc:CompanyID>{{ buyer_details.vat_id }}</cbc:CompanyID>
                    <cbc:ID>VAT</cbc:ID>
                </cac:TaxScheme>
            </cac:PartyTaxScheme>
            {% endif %}
            {% if buyer_details.registration_name %}
            <cac:PartyLegalEntity>
                <cbc:RegistrationName>{{ buyer_details.registration_name }}</cbc:RegistrationName>
            </cac:PartyLegalEntity>
            {% endif %}
        </cac:Party>
    </cac:AccountingCustomerParty>

    <!-- TODO: Discussion -->
    {% if invoice.sales_order_id %}
    <cac:Delivery>
        <cbc:ActualDeliveryDate>2022-09-07</cbc:ActualDeliveryDate>
        <cbc:LastDeliveryDate>2022-09-07</cbc:LastDeliveryDate>
    </cac:Delivery>
    {% endif %}

    <!-- TODO: Pre-paid -->
    {% if invoice.is_pos %}
    <cac:PaymentMeans>
        <cbc:PaymentMeansCode>10</cbc:PaymentMeansCode>
    </cac:PaymentMeans>
    {% endif %}

    <!--TODO: Implement Allowances -->
    {% if invoice.allowance_indicator %}
    <cac:AllowanceCharge>
        <cbc:ChargeIndicator>"false"</cbc:ChargeIndicator>
        <cbc:MultiplierFactorNumeric>20</cbc:MultiplierFactorNumeric>
        <cbc:Amount currencyID="SAR">20.24</cbc:Amount>
        <cbc:BaseAmount currencyID="SAR">200</cbc:BaseAmount>
        <cac:TaxCategory>
            <cbc:ID>S</cbc:ID>
            <cbc:Percent>20</cbc:Percent>
            <cac:TaxScheme>
                <cbc:ID>VAT</cbc:ID>
            </cac:TaxScheme>
        </cac:TaxCategory>
        <cbc:AllowanceChargeReason>"Reason of Allowance</cbc:AllowanceChargeReason>
        <cbc:AllowanceChargeReasonCode>95</cbc:AllowanceChargeReasonCode>

    </cac:AllowanceCharge>
    {% endif %}

    <!--TODO: Implement Charges -->
    {% if invoice.charge_indicator %}
    <cac:AllowanceCharge>
        <cbc:ChargeIndicator>true</cbc:ChargeIndicator>
        <cbc:MultiplierFactorNumeric>20</cbc:MultiplierFactorNumeric>
        <cbc:Amount currencyID="SAR">20.24</cbc:Amount>
        <cbc:BaseAmount currencyID="SAR">200</cbc:BaseAmount>
        <cac:TaxCategory>
            <cbc:ID>S</cbc:ID>
            <cbc:Percent>15</cbc:Percent>
            <cac:TaxScheme>
                <cbc:ID>VAT</cbc:ID>
            </cac:TaxScheme>
        </cac:TaxCategory>
        <cbc:AllowanceChargeReason>"Reason of Charge</cbc:AllowanceChargeReason>
        <cbc:AllowanceChargeReasonCode>CG</cbc:AllowanceChargeReasonCode>
    </cac:AllowanceCharge>
    {% endif %}

    <!-- Taxes -->
    <cac:TaxTotal>
        <cbc:TaxAmount currencyID="{{ invoice.tax_currency or 'SAR' }}">{{ invoice.total_taxes_and_charges or 0 }}
        </cbc:TaxAmount>
        <!-- Sales Taxes and Charges Child -->
        <cac:TaxSubtotal>
            <cbc:TaxableAmount currencyID="{{ invoice.currency_code }}">{{ invoice.total }}</cbc:TaxableAmount>
            <cbc:TaxAmount currencyID="{{ invoice.tax_currency or 'SAR' }}">{{ invoice.total_taxes_and_charges or 0 }}
            </cbc:TaxAmount>
            <cac:TaxCategory>
                <cbc:ID>S</cbc:ID>
                <cbc:Percent>{{ invoice.total_taxes_and_charges_percent or 0}}</cbc:Percent>
                <cac:TaxScheme>
                    <cbc:ID>VAT</cbc:ID>
                </cac:TaxScheme>
            </cac:TaxCategory>
        </cac:TaxSubtotal>
    </cac:TaxTotal>
    <cac:TaxTotal>
        <cbc:TaxAmount currencyID="{{ invoice.tax_currency or 'SAR'}}">{{ invoice.total_taxes_and_charges }}
        </cbc:TaxAmount>
    </cac:TaxTotal>

    <cac:LegalMonetaryTotal>
        <cbc:LineExtensionAmount currencyID="{{ invoice.currency_code }}">{{ invoice.total }}</cbc:LineExtensionAmount>
        {% if invoice.discount_amount %}
        <cbc:AllowanceTotalAmount currencyID="{{ invoice.currency_code }}">{{ invoice.discount_amount }}</cbc:AllowanceTotalAmount>
        {% endif %}
        <cbc:ChargeTotalAmount currencyID="{{ invoice.currency_code }}">0.00</cbc:ChargeTotalAmount>
        <cbc:TaxExclusiveAmount currencyID="{{ invoice.currency_code }}">{{ invoice.net_total }}</cbc:TaxExclusiveAmount>
        <cbc:TaxInclusiveAmount currencyID="{{ invoice.currency_code }}">{{ invoice.grand_total }}</cbc:TaxInclusiveAmount>
        {% if invoice.is_pos %} <!-- TODO: Discussion -->
        <cbc:PrepaidAmount currencyID="{{ invoice.currency_code }}">0.00</cbc:PrepaidAmount>
        {% endif %}
        {% if invoice.rounding_adjustment %}
        <cbc:PayableRoundingAmount currencyID="{{ invoice.currency_code }}">{{ invoice.rounding_adjustment }}
        </cbc:PayableRoundingAmount>
        {% endif %}
        <cbc:PayableAmount currencyID="{{ invoice.currency_code }}">{{ invoice.outstanding_amount }}</cbc:PayableAmount>
    </cac:LegalMonetaryTotal>

    <!-- Invoice item lines -->
    {% for item in invoice.item_lines %}
    <cac:InvoiceLine>
        <cbc:ID>{{ item.idx }}</cbc:ID>
        <!-- This is the name as note -->
        <cbc:Note>{{ item.item_name }}</cbc:Note>
        <cbc:InvoicedQuantity unitCode="PCE">{{ item.qty }}</cbc:InvoicedQuantity>
        <cbc:LineExtensionAmount currencyID="{{ invoice.currency_code }}">{{ item.net_amount or item.amount }}
        </cbc:LineExtensionAmount>
        <cac:Item>
            <cbc:Name>{{ item.item_name }}</cbc:Name>
            {% if item.buyer_item_identification %}
            <cac:BuyersItemIdentification>
                <cbc:ID>{{ item.buyer_item_identification }}</cbc:ID>
            </cac:BuyersItemIdentification>
            {% endif %}

            {% if item.seller_item_identification %}
            <cac:SellersItemIdentification>
                <cbc:ID>{{ item.seller_item_identification }}</cbc:ID>
            </cac:SellersItemIdentification>
            {% endif %}

            {% if item.idx %}
            <cac:StandardItemIdentification>
                <cbc:ID schemeID="GTIN" schemeAgencyID="9">{{ item.idx }}</cbc:ID>
            </cac:StandardItemIdentification>
            {% endif %}

            <ClassifiedTaxCategory xmlns="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2">
                <cbc:ID schemeID="UN/ECE 5305">S</cbc:ID>
                {% if item.tax_percent %}
                <cbc:Percent>{{ item.tax_percent }}</cbc:Percent>
                {% else %}
                <!--TODO: Add Exemption reason here-->
                <cbc:Percent>{{ 0.00 }}</cbc:Percent>
                {% endif %}
                <TaxScheme>
                    <cbc:ID schemeID="UN/ECE 5153">VAT</cbc:ID>
                </TaxScheme>
            </ClassifiedTaxCategory>

        </cac:Item>
        <cac:TaxTotal>
            {% if item.tax_amount %}
            <cbc:TaxAmount currencyID="{{ invoice.tax_currency or 'SAR' }}">{{ item.tax_amount }}</cbc:TaxAmount>
            {% else %}
            <cbc:TaxAmount currencyID="{{ invoice.tax_currency or 'SAR' }}">{{ 0.00 }}</cbc:TaxAmount>
            {% endif %}
            <cbc:RoundingAmount currencyID="{{ invoice.currency_code }}">{{ item.total_amount or item.net_amount }}</cbc:RoundingAmount>
        </cac:TaxTotal>
        <cac:Price>
            <cbc:PriceAmount currencyID="{{ invoice.currency_code }}">{{ item.price_list_rate or item.rate }}
            </cbc:PriceAmount>
            <cbc:BaseQuantity unitCode="PCE">{{ item.qty }}</cbc:BaseQuantity>
            <!--TODO: Implement Allowances -->
        </cac:Price>
    </cac:InvoiceLine>
    {% endfor %}
</Invoice>